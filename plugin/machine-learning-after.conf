# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set Plugin
# Copyright (c) 2021-2022 Core Rule Set project. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# OWASP CRS Plugin
# Plugin name: machine-learning
# Plugin description: 
# Rule ID block base: 9,516,000 - 9,516,999
# Plugin version: 1.0.0

# Documentation can be found here:
# https://github.com/coreruleset/machine-learning-plugin


##DEE 
# Below rule checks if the condition of "blocking" is already met 
# against threshold. And if so, ML model kicks in to optimize False positives
##DEE 

SecRule TX:BLOCKING_INBOUND_ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_threshold}" \
    "id:9516110,\
    phase:2,\
    deny,\
    t:none,\
    msg:'Inbound Anomaly Score Exceeded (Total Score: %{TX.BLOCKING_INBOUND_ANOMALY_SCORE}) - ML is kicking in',\
    tag:'anomaly-evaluation',\
    ver:'machine-learning-plugin/1.0.0',\
    severity:'CRITICAL',\
    chain,\
    setvar:'tx.inbound_anomaly_score=%{tx.anomaly_score}', \
    setvar:'tx.inbound_ml_status=%{tx.inbound_ml_status}'"
       SecRuleScript machine-learning-client.lua
##DEE 
# Below rule checks the status of ML model and makes a decision to pass
# if ML model allowed so.
##DEE 

SecRule TX:INBOUND_ML_STATUS "@eq %{tx.inbound_ml_pass_flag} " \
    "id:9516120,\
    phase:2,\
    pass,\
    t:none,\
    msg:'ML Model detected False Positive and stops deny or block',\
    logdata:'ML model status: %{tx.inbound_ml_status}'\
    tag:'anomaly-evaluation',\
    ver:'machine-learning-plugin/1.0.0',\
    severity:'NOTICE'"
